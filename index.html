import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  onSnapshot, 
  query, 
  deleteDoc, 
  doc 
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken,
  onAuthStateChanged 
} from 'firebase/auth';
import { Trash2, Plus, Download, TrendingUp, TrendingDown, Wallet, Share2, CheckCircle2 } from 'lucide-react';

// --- Firebase 配置 ---
const firebaseConfig = {
  apiKey: "AIzaSyD76WGGR6QwCMr-qXXPNfCxefLZWK5KI-c",
  authDomain: "transactions-2d7ca.firebaseapp.com",
  projectId: "transactions-2d7ca",
  storageBucket: "transactions-2d7ca.firebasestorage.app",
  messagingSenderId: "83055519403",
  appId: "1:83055519403:web:3c44154f221783392c79ee"
};

// --- Google Sheets 配置 ---
// 已更新為你提供的 Apps Script URL
const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbyZcgHrZmHCeCi034Ghk8h8uknjs-QTLML2a4rq893g5YN5sfj5xN-xKDFBfFaGinGl/exec"; 

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

export default function App() {
  const [user, setUser] = useState(null);
  const [transactions, setTransactions] = useState([]);
  const [loading, setLoading] = useState(true);
  const [syncing, setSyncing] = useState(false);
  const [lastSyncStatus, setLastSyncStatus] = useState(null); // 'success' | 'error' | null
  
  const [desc, setDesc] = useState('');
  const [customDesc, setCustomDesc] = useState('');
  const [price, setPrice] = useState('');
  const [quantity, setQuantity] = useState(1);
  const [type, setType] = useState('income');
  const [date, setDate] = useState(new Date().toISOString().split('T')[0]);

  const priceMap = {
    '毛巾': 25,
    '鎖匙扣': 20
  };

  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Firebase Auth Error:", error);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      if (!currentUser) setLoading(true);
    });
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    const collectionPath = collection(db, 'artifacts', appId, 'users', user.uid, 'transactions');
    const q = query(collectionPath);
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const sortedDocs = docs.sort((a, b) => new Date(b.date) - new Date(a.date) || (b.createdAt || 0) - (a.createdAt || 0));
      setTransactions(sortedDocs);
      setLoading(false);
    }, (error) => console.error("Firestore Error:", error));
    return () => unsubscribe();
  }, [user]);

  // 同步至 Google Sheets 的函數
  const syncToGoogleSheet = async (data) => {
    if (!GOOGLE_SHEET_URL) return;
    setSyncing(true);
    setLastSyncStatus(null);
    try {
      // 使用 fetch 發送數據到 Apps Script
      // 注意：Apps Script 的 doPost 配合 no-cors 模式
      await fetch(GOOGLE_SHEET_URL, {
        method: 'POST',
        mode: 'no-cors',
        cache: 'no-cache',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ...data, uid: user.uid })
      });
      setLastSyncStatus('success');
      // 3秒後移除成功圖示
      setTimeout(() => setLastSyncStatus(null), 3000);
    } catch (error) {
      console.error("Google Sheet Sync Error:", error);
      setLastSyncStatus('error');
    } finally {
      setSyncing(false);
    }
  };

  const handleProductChange = (val) => {
    setDesc(val);
    if (priceMap[val]) setPrice(priceMap[val]);
    else if (val === '其他') setPrice('');
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!user) return;

    const finalDesc = desc === '其他' ? customDesc : desc;
    const p = parseFloat(price);
    const q = parseInt(quantity);
    const transactionData = {
      desc: finalDesc,
      price: p,
      quantity: q,
      amount: p * q,
      type: type,
      date: date,
      createdAt: Date.now()
    };

    try {
      // 1. 存入 Firebase (主要資料庫)
      await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'), transactionData);
      
      // 2. 同步到 Google Sheet (備份/報表)
      await syncToGoogleSheet(transactionData);

      // 清空輸入
      setDesc('');
      setCustomDesc('');
      setPrice('');
      setQuantity(1);
    } catch (error) {
      console.error("Add Transaction Error:", error);
    }
  };

  const handleDelete = async (id) => {
    if (!user || !window.confirm('確定要從雲端刪除這筆記錄嗎？\n(注意：此操作不會影響已寫入 Google Sheet 的資料)')) return;
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'transactions', id));
    } catch (error) {
      console.error("Delete Error:", error);
    }
  };

  const stats = transactions.reduce((acc, curr) => {
    if (curr.type === 'income') acc.income += curr.amount;
    else acc.expense += curr.amount;
    return acc;
  }, { income: 0, expense: 0 });

  if (!user) {
    return (
      <div className="flex h-screen items-center justify-center bg-slate-50 font-sans">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p className="text-slate-600 font-medium tracking-wide">初始化雲端環境中...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans">
      <div className="max-w-5xl mx-auto">
        <header className="mb-8 text-center">
          <h1 className="text-3xl font-extrabold text-slate-800 tracking-tight text-center">小生意雲端記錄系統</h1>
          <div className="flex flex-wrap items-center justify-center gap-2 mt-3">
            <span className="flex items-center gap-1 text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2.5 py-1 rounded-full border border-emerald-100 uppercase tracking-tighter">
              Firebase: 已連線
            </span>
            <span className="flex items-center gap-1 text-[10px] font-bold text-blue-600 bg-blue-50 px-2.5 py-1 rounded-full border border-blue-100 uppercase tracking-tighter">
              Google Sheet: 已配置
            </span>
            <div className="w-full md:w-auto text-[10px] text-slate-400 font-mono mt-1 md:mt-0">
              ID: {user.uid}
            </div>
          </div>
        </header>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <StatCard label="目前結餘" value={stats.income - stats.expense} color="text-blue-600" icon={<Wallet className="w-5 h-5" />} />
          <StatCard label="總收入" value={stats.income} color="text-emerald-600" icon={<TrendingUp className="w-5 h-5" />} />
          <StatCard label="總支出" value={stats.expense} color="text-rose-600" icon={<TrendingDown className="w-5 h-5" />} />
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div className="lg:col-span-1">
            <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 sticky top-8">
              <h2 className="text-xl font-bold mb-6 text-slate-800 flex items-center gap-2">
                <Plus className="w-5 h-5 text-blue-500" /> 新增交易
              </h2>
              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <label className="block text-sm font-semibold text-slate-700 mb-1.5">產品名稱</label>
                  <select 
                    value={desc} 
                    onChange={(e) => handleProductChange(e.target.value)}
                    required
                    className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all appearance-none"
                  >
                    <option value="" disabled>請選擇產品</option>
                    <option value="毛巾">毛巾 (單價 $25)</option>
                    <option value="鎖匙扣">鎖匙扣 (單價 $20)</option>
                    <option value="其他">其他 (自行輸入)</option>
                  </select>
                  {desc === '其他' && (
                    <input 
                      type="text" 
                      value={customDesc}
                      onChange={(e) => setCustomDesc(e.target.value)}
                      placeholder="輸入產品名稱"
                      required
                      className="mt-2 w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                    />
                  )}
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-semibold text-slate-700 mb-1.5">單價</label>
                    <input 
                      type="number" 
                      value={price}
                      onChange={(e) => setPrice(e.target.value)}
                      required step="0.01"
                      className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-semibold text-slate-700 mb-1.5">數量</label>
                    <input 
                      type="number" 
                      value={quantity}
                      onChange={(e) => setQuantity(e.target.value)}
                      required min="1"
                      className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                    />
                  </div>
                </div>

                <div className="p-4 bg-slate-900 rounded-2xl flex justify-between items-center">
                  <span className="text-xs font-medium text-slate-400">總計金額</span>
                  <span className="text-xl font-bold text-white tracking-tight">${(parseFloat(price || 0) * quantity).toFixed(2)}</span>
                </div>

                <div className="grid grid-cols-2 gap-2">
                  <button type="button" onClick={() => setType('income')}
                    className={`p-3 rounded-xl border text-sm font-bold transition-all ${type === 'income' ? 'bg-emerald-500 text-white border-emerald-500 shadow-lg shadow-emerald-100' : 'bg-white text-slate-400 border-slate-200'}`}>收入 (+)</button>
                  <button type="button" onClick={() => setType('expense')}
                    className={`p-3 rounded-xl border text-sm font-bold transition-all ${type === 'expense' ? 'bg-rose-500 text-white border-rose-500 shadow-lg shadow-rose-100' : 'bg-white text-slate-400 border-slate-200'}`}>支出 (-)</button>
                </div>

                <input type="date" value={date} onChange={(e) => setDate(e.target.value)} required
                  className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none" />

                <button 
                  type="submit" 
                  disabled={syncing}
                  className={`w-full py-4 rounded-xl font-black text-white transition-all shadow-xl flex items-center justify-center gap-2 ${syncing ? 'bg-slate-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-200 active:scale-[0.98]'}`}
                >
                  {syncing ? (
                    <>
                      <div className="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></div>
                      同步雲端中...
                    </>
                  ) : lastSyncStatus === 'success' ? (
                    <>
                      <CheckCircle2 className="h-5 w-5" />
                      已成功儲存
                    </>
                  ) : '儲存並同步至雲端'}
                </button>
              </form>
            </div>
          </div>

          <div className="lg:col-span-2">
            <div className="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
              <div className="p-6 border-b border-slate-50 flex flex-col sm:flex-row justify-between items-center gap-4">
                <h2 className="text-xl font-bold text-slate-800">歷史交易清單</h2>
                <div className="flex gap-2 w-full sm:w-auto">
                  <a 
                    href="https://docs.google.com/spreadsheets/d/1TkcsQ-YOAqwAaHVslWa4UnDVJk8fV9m3RyRz_ZT9mg8/edit" 
                    target="_blank" 
                    rel="noreferrer"
                    className="flex-1 sm:flex-none text-xs font-bold text-emerald-600 flex items-center justify-center gap-1.5 hover:bg-emerald-50 px-4 py-2 rounded-xl transition-all border border-emerald-100"
                  >
                    <Share2 className="w-3.5 h-3.5" /> 開啟試算表
                  </a>
                </div>
              </div>

              {loading ? (
                <div className="p-20 text-center text-slate-300 font-medium tracking-wide">雲端數據讀取中...</div>
              ) : transactions.length === 0 ? (
                <div className="p-20 text-center text-slate-400 font-medium tracking-wide">目前沒有任何記錄</div>
              ) : (
                <div className="overflow-x-auto">
                  <table className="w-full text-left">
                    <thead className="bg-slate-50/50">
                      <tr className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                        <th className="px-6 py-4">日期</th>
                        <th className="px-6 py-4">項目</th>
                        <th className="px-6 py-4 text-center">數量</th>
                        <th className="px-6 py-4 text-right">金額</th>
                        <th className="px-6 py-4 text-center">管理</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-50">
                      {transactions.map((item) => (
                        <tr key={item.id} className="hover:bg-slate-50/30 transition-colors group">
                          <td className="px-6 py-4 text-sm text-slate-500 font-medium">{item.date}</td>
                          <td className="px-6 py-4 text-sm font-bold text-slate-800">{item.desc}</td>
                          <td className="px-6 py-4 text-sm text-center text-slate-500 font-bold">{item.quantity}</td>
                          <td className={`px-6 py-4 text-sm text-right font-black ${item.type === 'income' ? 'text-emerald-600' : 'text-rose-600'}`}>
                            {item.type === 'income' ? '+' : '-'}${item.amount.toLocaleString(undefined, { minimumFractionDigits: 2 })}
                          </td>
                          <td className="px-6 py-4 text-center">
                            <button 
                              onClick={() => handleDelete(item.id)} 
                              className="p-2 text-slate-200 hover:text-rose-500 transition-all active:scale-90"
                              title="刪除"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

function StatCard({ label, value, color, icon }) {
  return (
    <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex items-center gap-4 hover:shadow-lg hover:shadow-slate-200/50 transition-all group">
      <div className={`p-4 rounded-2xl transition-all group-hover:scale-110 group-hover:rotate-3 ${color.replace('text', 'bg').replace('600', '50')} ${color}`}>
        {icon}
      </div>
      <div>
        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-0.5">{label}</p>
        <p className={`text-2xl font-black tracking-tight ${color}`}>
          ${value.toLocaleString(undefined, { minimumFractionDigits: 2 })}
        </p>
      </div>
    </div>
  );
}
