import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  onSnapshot, 
  query, 
  deleteDoc, 
  doc 
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken,
  onAuthStateChanged 
} from 'firebase/auth';
import { Trash2, Plus, TrendingUp, TrendingDown, Wallet, CheckCircle2, AlertCircle } from 'lucide-react';

// --- Firebase 配置 ---
const firebaseConfig = {
  apiKey: "AIzaSyD76WGGR6QwCMr-qXXPNfCxefLZWK5KI-c",
  authDomain: "transactions-2d7ca.firebaseapp.com",
  projectId: "transactions-2d7ca",
  storageBucket: "transactions-2d7ca.firebasestorage.app",
  messagingSenderId: "83055519403",
  appId: "1:83055519403:web:3c44154f221783392c79ee"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

export default function App() {
  const [user, setUser] = useState(null);
  const [transactions, setTransactions] = useState([]);
  const [loading, setLoading] = useState(true);
  const [saveStatus, setSaveStatus] = useState(null); // 'success' | null
  const [authError, setAuthError] = useState(null);
  
  const [desc, setDesc] = useState('');
  const [customDesc, setCustomDesc] = useState('');
  const [price, setPrice] = useState('');
  const [quantity, setQuantity] = useState(1);
  const [type, setType] = useState('income');
  const [date, setDate] = useState(new Date().toISOString().split('T')[0]);

  const priceMap = {
    '毛巾': 25,
    '鎖匙扣': 20
  };

  useEffect(() => {
    const initAuth = async () => {
      try {
        // 修正 Auth 邏輯：優先嘗試權杖，若失敗或不存在則強制降級到匿名登入 (RULE 3)
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          try {
            await signInWithCustomToken(auth, __initial_auth_token);
          } catch (tokenError) {
            console.warn("Custom token failed, falling back to anonymous auth:", tokenError);
            await signInAnonymously(auth);
          }
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Firebase Auth Final Error:", error);
        setAuthError("身份驗證失敗，請重新載入頁面。");
      }
    };

    initAuth();
    
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      // 如果 Auth 完成但沒有 user，也要關閉 loading 顯示錯誤
      if (currentUser) {
        setAuthError(null);
      }
    });
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    // 確保使用者已登入後才發起 Firestore 監聽 (RULE 3)
    if (!user) return;

    setLoading(true);
    const collectionPath = collection(db, 'artifacts', appId, 'users', user.uid, 'transactions');
    const q = query(collectionPath);
    
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // 根據日期排序，日期相同則根據創建時間排序
      const sortedDocs = docs.sort((a, b) => {
        const dateDiff = new Date(b.date) - new Date(a.date);
        return dateDiff !== 0 ? dateDiff : (b.createdAt || 0) - (a.createdAt || 0);
      });
      setTransactions(sortedDocs);
      setLoading(false);
    }, (error) => {
      console.error("Firestore Error:", error);
      setLoading(false);
    });
    
    return () => unsubscribe();
  }, [user]);

  const handleProductChange = (val) => {
    setDesc(val);
    if (priceMap[val]) setPrice(priceMap[val]);
    else if (val === '其他') setPrice('');
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!user) return;

    const finalDesc = desc === '其他' ? customDesc : desc;
    const p = parseFloat(price);
    const q = parseInt(quantity);
    
    if (isNaN(p) || isNaN(q)) return;

    const transactionData = {
      desc: finalDesc,
      price: p,
      quantity: q,
      amount: p * q,
      type: type,
      date: date,
      createdAt: Date.now()
    };

    try {
      await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'), transactionData);
      
      setSaveStatus('success');
      setTimeout(() => setSaveStatus(null), 2000);

      // 清空輸入
      setDesc('');
      setCustomDesc('');
      setPrice('');
      setQuantity(1);
    } catch (error) {
      console.error("Add Transaction Error:", error);
    }
  };

  const handleDelete = async (id) => {
    if (!user || !window.confirm('確定要從雲端刪除這筆記錄嗎？')) return;
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'transactions', id));
    } catch (error) {
      console.error("Delete Error:", error);
    }
  };

  const stats = transactions.reduce((acc, curr) => {
    const amt = Number(curr.amount) || 0;
    if (curr.type === 'income') acc.income += amt;
    else acc.expense += amt;
    return acc;
  }, { income: 0, expense: 0 });

  // 錯誤狀態處理
  if (authError) {
    return (
      <div className="flex h-screen items-center justify-center bg-slate-50 font-sans">
        <div className="text-center p-8 bg-white rounded-3xl shadow-xl border border-rose-100 max-w-sm">
          <AlertCircle className="w-12 h-12 text-rose-500 mx-auto mb-4" />
          <p className="text-slate-800 font-bold mb-2 text-xl">連線發生問題</p>
          <p className="text-slate-500 text-sm">{authError}</p>
        </div>
      </div>
    );
  }

  // 初始加載狀態
  if (!user && loading) {
    return (
      <div className="flex h-screen items-center justify-center bg-slate-50 font-sans">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p className="text-slate-600 font-medium tracking-wide">驗證身份中...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans transition-all duration-500">
      <div className="max-w-6xl mx-auto">
        <header className="mb-8 text-center">
          <h1 className="text-3xl font-extrabold text-slate-800 tracking-tight">小生意雲端記錄系統</h1>
          <div className="flex flex-wrap items-center justify-center gap-2 mt-3">
            <span className="flex items-center gap-1.5 text-[10px] font-bold text-emerald-600 bg-emerald-50 px-3 py-1 rounded-full border border-emerald-100 uppercase tracking-widest">
              <span className="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span>
              Firebase: 已連線
            </span>
            <div className="w-full md:w-auto text-[10px] text-slate-400 font-mono mt-1 md:mt-0 bg-white px-2 py-1 rounded-md border border-slate-100">
              UID: {user?.uid || 'N/A'}
            </div>
          </div>
        </header>

        {/* 統計數值區 */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <StatCard label="目前結餘" value={stats.income - stats.expense} color="text-blue-600" icon={<Wallet className="w-5 h-5" />} />
          <StatCard label="總收入" value={stats.income} color="text-emerald-600" icon={<TrendingUp className="w-5 h-5" />} />
          <StatCard label="總支出" value={stats.expense} color="text-rose-600" icon={<TrendingDown className="w-5 h-5" />} />
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
          {/* 左側表單 */}
          <div className="lg:col-span-4">
            <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 lg:sticky lg:top-8">
              <h2 className="text-xl font-bold mb-6 text-slate-800 flex items-center gap-2">
                <Plus className="w-5 h-5 text-blue-500" /> 新增交易
              </h2>
              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <label className="block text-sm font-semibold text-slate-700 mb-1.5">產品名稱</label>
                  <select 
                    value={desc} 
                    onChange={(e) => handleProductChange(e.target.value)}
                    required
                    className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all appearance-none cursor-pointer"
                  >
                    <option value="" disabled>請選擇產品</option>
                    <option value="毛巾">毛巾 (單價 $25)</option>
                    <option value="鎖匙扣">鎖匙扣 (單價 $20)</option>
                    <option value="其他">其他 (自行輸入)</option>
                  </select>
                  {desc === '其他' && (
                    <input 
                      type="text" 
                      value={customDesc}
                      onChange={(e) => setCustomDesc(e.target.value)}
                      placeholder="輸入產品名稱"
                      required
                      className="mt-2 w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                    />
                  )}
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-semibold text-slate-700 mb-1.5">單價</label>
                    <input 
                      type="number" 
                      value={price}
                      onChange={(e) => setPrice(e.target.value)}
                      required step="0.01"
                      className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-semibold text-slate-700 mb-1.5">數量</label>
                    <input 
                      type="number" 
                      value={quantity}
                      onChange={(e) => setQuantity(e.target.value)}
                      required min="1"
                      className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                    />
                  </div>
                </div>

                <div className="p-4 bg-slate-900 rounded-2xl flex justify-between items-center transition-all">
                  <span className="text-xs font-medium text-slate-400">總計金額</span>
                  <span className="text-xl font-bold text-white tracking-tight">${(parseFloat(price || 0) * quantity).toFixed(2)}</span>
                </div>

                <div className="grid grid-cols-2 gap-2">
                  <button type="button" onClick={() => setType('income')}
                    className={`p-3 rounded-xl border text-sm font-bold transition-all ${type === 'income' ? 'bg-emerald-500 text-white border-emerald-500 shadow-lg shadow-emerald-100' : 'bg-white text-slate-400 border-slate-200 hover:border-slate-300'}`}>收入 (+)</button>
                  <button type="button" onClick={() => setType('expense')}
                    className={`p-3 rounded-xl border text-sm font-bold transition-all ${type === 'expense' ? 'bg-rose-500 text-white border-rose-500 shadow-lg shadow-rose-100' : 'bg-white text-slate-400 border-slate-200 hover:border-slate-300'}`}>支出 (-)</button>
                </div>

                <input type="date" value={date} onChange={(e) => setDate(e.target.value)} required
                  className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" />

                <button 
                  type="submit" 
                  disabled={!user}
                  className={`w-full py-4 rounded-xl font-black text-white transition-all shadow-xl flex items-center justify-center gap-2 ${saveStatus === 'success' ? 'bg-emerald-600' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-200 active:scale-[0.98]'}`}
                >
                  {saveStatus === 'success' ? (
                    <>
                      <CheckCircle2 className="h-5 w-5" />
                      儲存成功
                    </>
                  ) : '儲存記錄'}
                </button>
              </form>
            </div>
          </div>

          {/* 右側表格 */}
          <div className="lg:col-span-8">
            <div className="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden min-h-[400px] flex flex-col">
              <div className="p-6 border-b border-slate-50 flex justify-between items-center bg-white">
                <h2 className="text-xl font-bold text-slate-800">歷史交易清單</h2>
                <div className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                  共 {transactions.length} 筆
                </div>
              </div>

              {loading ? (
                <div className="flex-1 flex items-center justify-center">
                  <div className="text-center">
                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-slate-300 mx-auto mb-3"></div>
                    <p className="text-slate-400 text-sm font-medium">讀取雲端數據...</p>
                  </div>
                </div>
              ) : transactions.length === 0 ? (
                <div className="flex-1 flex items-center justify-center p-20 text-center">
                  <div>
                    <div className="bg-slate-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                      <Plus className="w-8 h-8 text-slate-200" />
                    </div>
                    <p className="text-slate-400 font-medium tracking-wide">目前尚未有任何記錄</p>
                  </div>
                </div>
              ) : (
                <div className="overflow-x-auto flex-1">
                  <table className="w-full text-left">
                    <thead className="bg-slate-50/50 sticky top-0 backdrop-blur-md">
                      <tr className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                        <th className="px-6 py-4">日期</th>
                        <th className="px-6 py-4">項目</th>
                        <th className="px-6 py-4 text-center">數量</th>
                        <th className="px-6 py-4 text-right">金額</th>
                        <th className="px-6 py-4 text-center">管理</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-50">
                      {transactions.map((item) => (
                        <tr key={item.id} className="hover:bg-slate-50/50 transition-colors group">
                          <td className="px-6 py-4 text-sm text-slate-500 font-medium">{item.date}</td>
                          <td className="px-6 py-4 text-sm font-bold text-slate-800">{item.desc}</td>
                          <td className="px-6 py-4 text-sm text-center text-slate-500 font-bold">{item.quantity}</td>
                          <td className={`px-6 py-4 text-sm text-right font-black ${item.type === 'income' ? 'text-emerald-600' : 'text-rose-600'}`}>
                            {item.type === 'income' ? '+' : '-'}${Number(item.amount).toLocaleString(undefined, { minimumFractionDigits: 2 })}
                          </td>
                          <td className="px-6 py-4 text-center">
                            <button 
                              onClick={() => handleDelete(item.id)} 
                              className="p-2 text-slate-200 hover:text-rose-500 hover:bg-rose-50 rounded-lg transition-all active:scale-90"
                              title="刪除"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

function StatCard({ label, value, color, icon }) {
  return (
    <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex items-center gap-4 hover:shadow-lg hover:shadow-slate-200/50 transition-all group cursor-default">
      <div className={`p-4 rounded-2xl transition-all group-hover:scale-110 group-hover:rotate-3 ${color.replace('text', 'bg').replace('600', '50')} ${color}`}>
        {icon}
      </div>
      <div>
        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-0.5">{label}</p>
        <p className={`text-2xl font-black tracking-tight ${color}`}>
          ${Number(value).toLocaleString(undefined, { minimumFractionDigits: 2 })}
        </p>
      </div>
    </div>
  );
}
