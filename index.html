<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交易記錄管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-800">交易記錄管理</h1>
            <p class="text-gray-600 mt-2">同步更新至 Google Sheets (支援刪除標記)</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- 輸入表單 -->
            <div class="md:col-span-1 bg-white p-6 rounded-xl shadow-md h-fit">
                <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">新增交易</h2>
                <form id="transactionForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">產品</label>
                        <select id="product" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="" disabled selected>請選擇產品</option>
                            <option value="毛巾" data-price="25">毛巾 ($25)</option>
                            <option value="鎖匙扣" data-price="20">鎖匙扣 ($20)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">交易日期</label>
                        <input type="date" id="date" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">數量</label>
                        <select id="quantity" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <!-- JS will populate options 1-50 -->
                        </select>
                    </div>

                    <div class="pt-4">
                        <button type="submit" id="submitBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                            新增記錄
                        </button>
                    </div>
                </form>
            </div>

            <!-- 記錄列表 -->
            <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-xl font-semibold text-gray-700">歷史記錄</h2>
                    <span id="syncStatus" class="text-xs text-gray-400">尚未連線</span>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-gray-500 text-sm uppercase">
                                <th class="px-2 py-3 border-b">日期</th>
                                <th class="px-2 py-3 border-b">產品</th>
                                <th class="px-2 py-3 border-b">數量</th>
                                <th class="px-2 py-3 border-b">總額</th>
                                <th class="px-2 py-3 border-b text-right">操作</th>
                            </tr>
                        </thead>
                        <tbody id="recordList" class="text-gray-700">
                            <!-- Rows added dynamically -->
                        </tbody>
                        <tfoot>
                            <tr class="font-bold bg-gray-50">
                                <td colspan="3" class="px-2 py-3 text-right">當前頁面總計：</td>
                                <td colspan="2" class="px-2 py-3 text-blue-600" id="grandTotal">$0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 transition-transform duration-300 opacity-0 pointer-events-none">
        提示訊息
    </div>

    <script>
        // API URL
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwqAwQj-2MHcMFImO6IbSC7NGL_TEmsSfGoEHj-SvPNsUX-SnirFihFFywRSnOoxBD8ng/exec';

        // Local State
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];

        // Initial setup
        window.onload = () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;

            const qtySelect = document.getElementById('quantity');
            for (let i = 1; i <= 50; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = i;
                qtySelect.appendChild(opt);
            }

            renderRecords();
        };

        // Form Submission
        document.getElementById('transactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productSelect = document.getElementById('product');
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const price = parseInt(selectedOption.getAttribute('data-price'));
            const qty = parseInt(document.getElementById('quantity').value);

            const newRecord = {
                id: "ID-" + Date.now(), // Unique ID for finding row in sheet
                date: document.getElementById('date').value,
                product: productSelect.value,
                quantity: qty,
                price: price,
                total: price * qty,
                status: 'active'
            };

            // Update Local
            transactions.unshift(newRecord);
            saveData();
            renderRecords();
            showToast('已新增並同步中...');

            // Sync to Sheet
            syncData(newRecord);
        });

        // Delete Logic
        function deleteRecord(id) {
            const index = transactions.findIndex(t => t.id === id);
            if (index === -1) return;

            if (confirm('確定要刪除此記錄嗎？這將會在 Google Sheet 同步標記為 del。')) {
                const itemToDelete = { ...transactions[index], status: 'del' };
                
                // Update Local UI immediately
                transactions.splice(index, 1);
                saveData();
                renderRecords();
                
                showToast('正在同步刪除標記...');
                syncData(itemToDelete);
            }
        }

        // Sync Function
        async function syncData(payload) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.textContent = '正在同步...';
            statusEl.className = 'text-xs text-blue-500';

            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                statusEl.textContent = '最後同步於 ' + new Date().toLocaleTimeString();
                statusEl.className = 'text-xs text-green-500';
            } catch (error) {
                console.error('Sync error:', error);
                statusEl.textContent = '同步失敗';
                statusEl.className = 'text-xs text-red-500';
            }
        }

        // Helpers
        function renderRecords() {
            const list = document.getElementById('recordList');
            list.innerHTML = '';
            let total = 0;

            transactions.forEach(item => {
                total += item.total;
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="px-2 py-4 text-sm">${item.date}</td>
                    <td class="px-2 py-4 font-medium">${item.product}</td>
                    <td class="px-2 py-4">${item.quantity}</td>
                    <td class="px-2 py-4 font-semibold text-blue-600">$${item.total}</td>
                    <td class="px-2 py-4 text-right">
                        <button onclick="deleteRecord('${item.id}')" class="text-red-500 hover:text-red-700 text-sm font-medium">
                            刪除
                        </button>
                    </td>
                `;
                list.appendChild(row);
            });

            document.getElementById('grandTotal').textContent = `$${total}`;
        }

        function saveData() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.remove('translate-y-20', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');
            
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
                toast.classList.remove('translate-y-0', 'opacity-100');
            }, 3000);
        }
    </script>
</body>
</html>
