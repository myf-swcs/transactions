<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小生意交易記錄系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <!-- 標題區 -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-slate-800">小生意交易記錄</h1>
            <p class="text-slate-500 mt-2">隨時追蹤你的收入與支出</p>
        </header>

        <!-- 數據概覽卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <p class="text-sm text-slate-500 mb-1">總結餘</p>
                <p id="totalBalance" class="text-2xl font-bold text-blue-600">$ 0</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <p class="text-sm text-slate-500 mb-1">總收入</p>
                <p id="totalIncome" class="text-2xl font-bold text-emerald-600">$ 0</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <p class="text-sm text-slate-500 mb-1">總支出</p>
                <p id="totalExpense" class="text-2xl font-bold text-rose-600">$ 0</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- 新增交易表單 -->
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 sticky top-8">
                    <h2 class="text-xl font-bold mb-4 text-slate-800">新增交易</h2>
                    <form id="transactionForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">交易名稱</label>
                            <input type="text" id="desc" required placeholder="例如：商品銷售、進貨費" 
                                class="w-full p-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">金額</label>
                            <input type="number" id="amount" required placeholder="0.00" step="0.01"
                                class="w-full p-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">類型</label>
                            <select id="type" class="w-full p-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="income">收入 (+)</option>
                                <option value="expense">支出 (-)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">日期</label>
                            <input type="date" id="date" required
                                class="w-full p-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button type="submit" class="w-full bg-slate-800 text-white py-2 rounded-lg font-medium hover:bg-slate-700 transition">
                            儲存記錄
                        </button>
                    </form>
                </div>
            </div>

            <!-- 歷史記錄清單 -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                        <h2 class="text-xl font-bold text-slate-800">歷史記錄</h2>
                        <button onclick="exportToCSV()" class="text-sm text-blue-600 hover:text-blue-800 font-medium">匯出 CSV</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-6 py-3 text-sm font-medium text-slate-500">日期</th>
                                    <th class="px-6 py-3 text-sm font-medium text-slate-500">說明</th>
                                    <th class="px-6 py-3 text-sm font-medium text-slate-500 text-right">金額</th>
                                    <th class="px-6 py-3 text-sm font-medium text-slate-500 text-center">操作</th>
                                </tr>
                            </thead>
                            <tbody id="transactionList" class="divide-y divide-slate-100">
                                <!-- 動態插入內容 -->
                            </tbody>
                        </table>
                    </div>
                    <div id="emptyState" class="p-12 text-center text-slate-400 hidden">
                        目前尚無交易記錄
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 資料庫初始化 (IndexedDB) ---
        let db;
        const request = indexedDB.open("ShopTrackerDB", 1);

        request.onupgradeneeded = (e) => {
            db = e.target.result;
            if (!db.objectStoreNames.contains("transactions")) {
                db.createObjectStore("transactions", { keyPath: "id", autoIncrement: true });
            }
        };

        request.onsuccess = (e) => {
            db = e.target.result;
            loadTransactions();
        };

        // 設定預設日期為今天
        document.getElementById('date').valueAsDate = new Date();

        // --- 表單提交處理 ---
        document.getElementById('transactionForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const transaction = {
                desc: document.getElementById('desc').value,
                amount: parseFloat(document.getElementById('amount').value),
                type: document.getElementById('type').value,
                date: document.getElementById('date').value,
                createdAt: new Date().getTime()
            };

            const tx = db.transaction("transactions", "readwrite");
            const store = tx.objectStore("transactions");
            store.add(transaction);

            tx.oncomplete = () => {
                document.getElementById('transactionForm').reset();
                document.getElementById('date').valueAsDate = new Date();
                loadTransactions();
            };
        });

        // --- 載入並顯示資料 ---
        function loadTransactions() {
            const tx = db.transaction("transactions", "readonly");
            const store = tx.objectStore("transactions");
            const request = store.getAll();

            request.onsuccess = () => {
                const data = request.result;
                // 按日期排序 (由新到舊)
                data.sort((a, b) => new Date(b.date) - new Date(a.date) || b.createdAt - a.createdAt);
                renderTable(data);
                updateStats(data);
            };
        }

        function renderTable(data) {
            const list = document.getElementById('transactionList');
            const emptyState = document.getElementById('emptyState');
            list.innerHTML = '';

            if (data.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            } else {
                emptyState.classList.add('hidden');
            }

            data.forEach(item => {
                const isIncome = item.type === 'income';
                const row = document.createElement('tr');
                row.className = "hover:bg-slate-50 transition";
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm text-slate-600">${item.date}</td>
                    <td class="px-6 py-4 text-sm font-medium text-slate-800">${item.desc}</td>
                    <td class="px-6 py-4 text-sm text-right font-bold ${isIncome ? 'text-emerald-600' : 'text-rose-600'}">
                        ${isIncome ? '+' : '-'}$${item.amount.toLocaleString()}
                    </td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="deleteTransaction(${item.id})" class="text-slate-300 hover:text-rose-500 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </td>
                `;
                list.appendChild(row);
            });
        }

        function updateStats(data) {
            let income = 0;
            let expense = 0;

            data.forEach(item => {
                if (item.type === 'income') income += item.amount;
                else expense += item.amount;
            });

            document.getElementById('totalIncome').innerText = `$ ${income.toLocaleString()}`;
            document.getElementById('totalExpense').innerText = `$ ${expense.toLocaleString()}`;
            document.getElementById('totalBalance').innerText = `$ ${(income - expense).toLocaleString()}`;
        }

        // --- 刪除功能 ---
        function deleteTransaction(id) {
            const tx = db.transaction("transactions", "readwrite");
            const store = tx.objectStore("transactions");
            store.delete(id);
            tx.oncomplete = () => loadTransactions();
        }

        // --- 匯出 CSV ---
        function exportToCSV() {
            const tx = db.transaction("transactions", "readonly");
            const store = tx.objectStore("transactions");
            const request = store.getAll();

            request.onsuccess = () => {
                const data = request.result;
                if (data.length === 0) return;

                let csvContent = "\uFEFF日期,說明,類型,金額\n"; // \uFEFF 解決 Excel 中文亂碼
                data.forEach(item => {
                    const typeLabel = item.type === 'income' ? '收入' : '支出';
                    csvContent += `${item.date},${item.desc},${typeLabel},${item.amount}\n`;
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `交易記錄_${new Date().toLocaleDateString()}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
        }
    </script>
</body>
</html>